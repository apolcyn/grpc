#!/bin/bash
set -ex

cd "$(dirname $0)"

# parse arguments
SYMBOLS_DIR="$1"
OUTPUT_DIR="$2"
PLATFORM="$3"
if [[ "$SYMBOLS_DIR" == "" ]]; then
  echo "first argument must be directory containing symbol files"
  exit 1
fi
if [[ "$OUTPUT_DIR" == "" ]]; then
  echo "second argument must be output directory"
  exit 1
fi
if ! test -d "$OUTPUT_DIR"; then
  echo "second argument is not a directory"
  exit 1
fi
if [[ "$PLATFORM" == "" ]]; then
  echo "third argument must be a ruby gem platform"
  exit 1
fi

# generate package contents dynamically
tmp="$(mktemp -d)"
cp grpc-native-debug.gemspec "$tmp"
cp README.md "$tmp"
cp version.rb "$tmp"
cp platform.rb "$tmp"
sed -i "s/# GENERATED BY BUILD_PACKAGES SCRIPT/'${PLATFORM}'/" "${tmp}/platform.rb"
mkdir -p "${tmp}/symbols"
cp "${SYMBOLS_DIR}"/*.dbg "${tmp}/symbols/"

# sanity check symbol file names
for f in "$(ls ${tmp}/symbols)"; do
  if [[ "$f" != *"$PLATFORM" ]]; then
    echo "symbols file names should contain the ruby platform: $PLATFORM"
    exit 1
  fi
done

# build
cd "$tmp"
gem build grpc-native-debug.gemspec
cp grpc-native-debug*.gem "$OUTPUT_DIR"
