#!/bin/bash
set -ex

cd "$(dirname $0)"

# parse arguments
SYMBOLS_DIR="$1"
OUTPUT_DIR="$2"
if [[ "$SYMBOLS_DIR" == "" ]]; then
  echo "first argument must be directory containing symbol files"
  exit 1
fi
if [[ "$OUTPUT_DIR" == "" ]]; then
  echo "second argument must be output directory"
  exit 1
fi
PLATFORM="$(basename $SYMBOLS_DIR)"
# copy grpc-native-debug directory to a staging location
tmp="$(mktemp -d)"
cp grpc-native-debug.gemspec "$tmp"
cp README.md "$tmp"
cp version.rb "$tmp"
cp platform.rb "$tmp"
# copy symbol files into the staged grpc-native-debug package
mkdir -p "${tmp}/symbols"
cp -r "${SYMBOLS_DIR}"/** "${tmp}/symbols/"
cd "$tmp"
# set Gem::Platform appropriately
sed -i "s/# GENERATED BY BUILD_PACKAGES SCRIPT/'${PLATFORM}'/" "${tmp}/platform.rb"
# build
cd $tmp
gem build grpc-native-debug.gemspec
cp grpc-native-debug*.gem "$OUTPUT_DIR"
